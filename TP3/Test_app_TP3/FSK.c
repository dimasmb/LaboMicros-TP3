/***************************************************************************//**
  @file     FSK.c
  @brief    Implementacion de Modulador y Demodulador FSK.
  @author   Enrique Irigoyen
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

#include "FSK.h"
#include "DAC.h"
#include "SysTick.h"
#include "BufferCirc.h"
#include "gpio.h"


/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/
#define MAXPTR 24

#define FSKBITS 11

#define FREQFACTOR (((float)2200)/((float)1200))

#define FIRORDER 24
/*******************************************************************************
 * ENUMERATIONS AND STRUCTURES AND TYPEDEFS
 ******************************************************************************/
enum Status {
    NODATA,
    FULL
};
/*******************************************************************************
 * FUNCTION PROTOTYPES FOR PRIVATE FUNCTIONS WITH FILE LEVEL SCOPE
 ******************************************************************************/

void fsk_callback (void);


/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 *******************************************************************************/


float SinePointer = 0;
int PointCount= 0;
int dataIn =0;
char isHighFreq=0;
char currBit=1;
/*const  uint16_t SineBuffer[32] =
{
  2048, 2447, 2831, 3185, 3495, 3750, 3939, 4056,
  4095, 4056, 3939, 3750, 3495, 3185, 2831, 2447,
  2048, 1648, 1264,  910,  600,  345,  156,   39,
     0,   39,  156,  345,  600,  910, 1264, 1648
};*/

const  uint16_t SineBuffer[MAXPTR] = {
    2048, 2577, 3071, 3495, 3820, 4025,
    4095, 4025, 3820, 3495, 3071, 2577,
    2048, 1518, 1024, 0600, 0275, 0070,
    0001, 0070, 0275, 0600, 1024, 1518};

uint8_t RxBuffer[3];

const float filterCoefs[FIRORDER+1]={
0.001946826865000082004003578717288291955,
0.009650559942067999524839549962962337304,
0.013372881939038832460608929864065430593,
0.022228881677292370439014135286015516613,
0.032219640509280431106553521658497629687,
0.044075619767476578725329261487786425278,
0.056944145205827488565031302414354286157,
0.070136022764213906688368638242536690086,
0.082734151038570125091808904471690766513,
0.093792795797168079796612971676950110123,
0.102431714479333746403710847516776993871,
0.107930640754909962231167241952789481729,
0.109818953600976418338852624856372131035,
0.107930640754909962231167241952789481729,
0.102431714479333746403710847516776993871,
0.093792795797168079796612971676950110123,
0.082734151038570125091808904471690766513,
0.070136022764213906688368638242536690086,
0.056944145205827488565031302414354286157,
0.044075619767476578725329261487786425278,
0.032219640509280431106553521658497629687,
0.022228881677292370439014135286015516613,
0.013372881939038832460608929864065430593,
0.009650559942067999524839549962962337304,
0.001946826865000082004003578717288291955
};


/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

void Init_FSK(void){

    DAC_Init();
    SysTick_Init(fsk_callback);
    clearBuff();
    gpioMode(PORTNUM2PIN(PC,10),OUTPUT);


}

void Tx_Fsk(uint16_t data){
    
    int i=0;
    for(i=1;i<=FSKBITS;i++){
    	uint8_t datanw=(data>>(FSKBITS-i))&0x01;
        insertChar(datanw);
    }
    dataIn+=12;

}
uint8_t isRxDataFull(void){


}
uint16_t getRxData(void){


}

/*******************************************************************************
 *******************************************************************************
                        LOCAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

void fsk_callback (void){
	gpioToggle(PORTNUM2PIN(PC,10));
    if(dataIn && !currBit){
            DAC_SetData(SineBuffer[(int)SinePointer]);
            SinePointer+=(float)FREQFACTOR;
            isHighFreq+=1;
    }
    else{
    	DAC_SetData(SineBuffer[(int)SinePointer]);
    	SinePointer+=1;

    }

    if(SinePointer>=MAXPTR){
        SinePointer=0;
        if(!isHighFreq && dataIn){
        	dataIn--;
            if(dataIn){
                currBit=getChar();
            }else{
            	currBit=1;
            }
        }
        else if(isHighFreq>=20 && dataIn){
            isHighFreq=0;
            dataIn--;
            if(dataIn){
                currBit=getChar();
            } else{
            	currBit=1;
            }
        }
    }
    //Read ADC and save
    
}

 
